<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamParty Final</title>
    <meta name="theme-color" content="#0f172a">
    
    <!-- Librer√≠as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #fff; overflow: hidden; height: 100vh; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Animaciones */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Layout Responsivo */
        .app-layout { display: flex; flex-direction: column; height: 100%; }
        @media (min-width: 1024px) { .app-layout { flex-direction: row; } }
        
        .mic-active { box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, setDoc, arrayRemove, collection } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { 
            Play, Pause, Users, LogOut, Send, Mic, MicOff, Search, Loader2, 
            Crown, Zap, Link, Volume2, MonitorPlay, ExternalLink, Copy, Check
        } from 'https://esm.sh/lucide-react@0.344.0';

        // --- CONFIGURACI√ìN FIREBASE (NO TOCAR) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJNTDKf8RrUQ_bvt9z1FD3hBQ9TtgFcuE",
            authDomain: "streaming-72bc2.firebaseapp.com",
            projectId: "streaming-72bc2",
            storageBucket: "streaming-72bc2.firebasestorage.app",
            messagingSenderId: "118775184891",
            appId: "1:118775184891:web:e3234a80dad9beec725f5e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'sp-final-v9'; 

        // --- UTILIDADES ---
        const generateId = () => Math.random().toString(36).substring(2, 6).toUpperCase();
        const getYouTubeId = (url) => {
            if (!url) return null;
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        // --- HOOK DE AUDIO (CHAT DE VOZ) ---
        const useVoice = (user, partyId, users) => {
            const [muted, setMuted] = useState(false);
            const [stream, setStream] = useState(null);
            const peerRef = useRef(null);
            const containerRef = useRef(null);

            useEffect(() => {
                if(!user || !partyId) return;
                const peer = new window.Peer(user.uid.substring(0,8) + partyId);
                
                peer.on('open', () => {
                    navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
                        setStream(s);
                        peerRef.current = peer;
                        
                        peer.on('call', call => {
                            call.answer(s);
                            call.on('stream', rem => addAudio(rem));
                        });
                    }).catch(e => console.log("Sin microfono"));
                });

                return () => { peer.destroy(); if(stream) stream.getTracks().forEach(t=>t.stop()); };
            }, [user, partyId]);

            useEffect(() => {
                if(!peerRef.current || !stream || !users) return;
                users.forEach(u => {
                    if(u.uid !== user.uid) {
                        const call = peerRef.current.call(u.uid.substring(0,8) + partyId, stream);
                        if(call) call.on('stream', rem => addAudio(rem));
                    }
                });
            }, [users]);

            const addAudio = (st) => {
                const aud = document.createElement('audio');
                aud.srcObject = st; aud.autoplay = true;
                if(containerRef.current) containerRef.current.appendChild(aud);
            };

            const toggle = () => {
                if(stream) {
                    stream.getAudioTracks()[0].enabled = !stream.getAudioTracks()[0].enabled;
                    setMuted(!stream.getAudioTracks()[0].enabled);
                }
            };

            return { muted, toggle, containerRef };
        };

        // --- REPRODUCTOR YOUTUBE ---
        const YTPlayer = ({ videoId, state, isHost, onUpdate }) => {
            const ref = useRef(null);
            
            useEffect(() => {
                if(!window.YT) return;
                ref.current = new window.YT.Player('yt-player', {
                    height: '100%', width: '100%', videoId: videoId,
                    playerVars: { playsinline: 1, controls: 1, rel: 0, modestbranding: 1, origin: window.location.origin },
                    events: {
                        'onReady': e => { if(state.isPlaying) e.target.playVideo(); },
                        'onStateChange': e => { if(isHost && (e.data===1||e.data===2)) onUpdate(e.data===1, e.target.getCurrentTime()); }
                    }
                });
                const i = setInterval(() => {
                    if(!ref.current?.getPlayerState || isHost) return;
                    const t = state.isPlaying ? state.timestamp + (Date.now()-state.lastUpdated)/1000 : state.timestamp;
                    if(Math.abs(ref.current.getCurrentTime() - t) > 2) ref.current.seekTo(t, true);
                    const s = ref.current.getPlayerState();
                    if(state.isPlaying && s!==1 && s!==3) ref.current.playVideo();
                    if(!state.isPlaying && s===1) ref.current.pauseVideo();
                }, 1000);
                return () => { clearInterval(i); try{ref.current.destroy()}catch(e){} };
            }, [videoId]);

            return <div id="yt-player" className="w-full h-full bg-black"></div>;
        };

        // --- CONTROLADOR CRUNCHYROLL (SYNC TIMER) ---
        const CrunchyController = ({ state, isHost, onUpdate }) => {
            const [time, setTime] = useState(state.timestamp);

            useEffect(() => {
                let i;
                if(state.isPlaying) i = setInterval(() => setTime(prev => prev + 1), 1000);
                else setTime(state.timestamp);
                return () => clearInterval(i);
            }, [state.isPlaying, state.lastUpdated]);

            // Resync fuerte
            useEffect(() => {
                const target = state.isPlaying ? state.timestamp + (Date.now() - state.lastUpdated)/1000 : state.timestamp;
                setTime(Math.floor(target));
            }, [state.lastUpdated]);

            const fmt = s => {
                const m = Math.floor(s/60); const sc = Math.floor(s%60);
                return `${m}:${sc<10?'0':''}${sc}`;
            }

            return (
                <div className="w-full h-full flex flex-col items-center justify-center bg-zinc-900 relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://wallpapers.com/images/hd/anime-scenery-background-1920-x-1080-h7k2d1k9q2k9k9k9.jpg')] bg-cover opacity-20"></div>
                    <div className="z-10 text-center p-6">
                        <div className="w-20 h-20 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-orange-500/50">
                            <Zap size={40} className="text-white"/>
                        </div>
                        <h2 className="text-3xl font-black text-white mb-2 tracking-tight">Sincronizador</h2>
                        <p className="text-zinc-400 mb-8 max-w-md">Abran el mismo cap√≠tulo en otra pesta√±a y usen este reloj para ir al mismo segundo.</p>
                        
                        <div className="text-7xl font-mono font-bold text-white mb-8 tabular-nums drop-shadow-lg">
                            {fmt(time)}
                        </div>

                        {isHost ? (
                            <button onClick={() => onUpdate(!state.isPlaying)} className={`w-20 h-20 rounded-full flex items-center justify-center transition-all ${state.isPlaying ? 'bg-zinc-800' : 'bg-white shadow-[0_0_40px_rgba(255,255,255,0.4)]'}`}>
                                {state.isPlaying ? <Pause size={32}/> : <Play size={32} fill="black" className="ml-1"/>}
                            </button>
                        ) : (
                            <div className="px-6 py-2 bg-orange-500/20 text-orange-400 rounded-full font-bold text-sm animate-pulse border border-orange-500/50">
                                Sincronizado con Host
                            </div>
                        )}
                        
                        <div className="mt-8 flex justify-center">
                            <a href="https://www.crunchyroll.com" target="_blank" className="flex items-center gap-2 text-zinc-400 hover:text-white transition text-sm font-medium">
                                <ExternalLink size={14}/> Abrir Crunchyroll
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD (SELECCI√ìN) ---
        const Dashboard = ({ user, create, join }) => {
            const [code, setCode] = useState('');
            
            return (
                <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6">
                    <div className="w-full max-w-5xl">
                        <header className="flex justify-between items-center mb-12">
                            <div className="flex items-center gap-4">
                                <img src={user.photoURL} className="w-12 h-12 rounded-full border-2 border-slate-700"/>
                                <div>
                                    <h1 className="text-2xl font-bold text-white">Hola, {user.displayName.split(' ')[0]}</h1>
                                    <p className="text-slate-400 text-sm">Elige tu plataforma</p>
                                </div>
                            </div>
                            <button onClick={() => signOut(auth)} className="text-red-400 hover:text-red-300 text-sm font-bold">Salir</button>
                        </header>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                            <div onClick={() => create('youtube')} className="bg-red-600 hover:bg-red-700 p-8 rounded-3xl cursor-pointer transition transform hover:scale-[1.02] relative overflow-hidden group">
                                <MonitorPlay size={64} className="text-white/20 absolute -right-4 -bottom-4 group-hover:scale-150 transition duration-500"/>
                                <h3 className="text-3xl font-black text-white mb-2">YouTube</h3>
                                <p className="text-red-100">Ver videos, m√∫sica y shorts sincronizados.</p>
                            </div>
                            <div onClick={() => create('crunchyroll')} className="bg-orange-500 hover:bg-orange-600 p-8 rounded-3xl cursor-pointer transition transform hover:scale-[1.02] relative overflow-hidden group">
                                <Zap size={64} className="text-black/10 absolute -right-4 -bottom-4 group-hover:scale-150 transition duration-500"/>
                                <h3 className="text-3xl font-black text-white mb-2">Crunchyroll</h3>
                                <p className="text-orange-100">Modo control remoto para anime.</p>
                            </div>
                        </div>

                        <div className="glass p-6 rounded-2xl flex flex-col md:flex-row gap-4 items-center">
                            <div className="flex-1">
                                <h4 className="font-bold text-lg">¬øTienes un c√≥digo?</h4>
                                <p className="text-slate-400 text-sm">√önete a la fiesta de un amigo.</p>
                            </div>
                            <div className="flex gap-2 w-full md:w-auto">
                                <input value={code} onChange={e=>setCode(e.target.value.toUpperCase())} placeholder="C√ìDIGO" className="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-center tracking-widest text-white outline-none focus:border-blue-500 uppercase flex-1"/>
                                <button onClick={() => join(code)} className="bg-white text-slate-900 font-bold px-6 rounded-xl hover:bg-slate-200">ENTRAR</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- SALA DE FIESTA ---
        const PartyRoom = ({ partyId, user, onLeave }) => {
            const [party, setParty] = useState(null);
            const [msgs, setMsgs] = useState([]);
            const [txt, setTxt] = useState('');
            const [search, setSearch] = useState('');
            const chatRef = useRef(null);
            const { muted, toggle, containerRef } = useVoice(user, partyId, party?.users);
            
            const isHost = party?.hostId === user.uid;

            useEffect(() => {
                const ref = doc(db, 'artifacts', APP_ID, 'parties', `party_${partyId}`);
                updateDoc(ref, { users: arrayUnion({ uid: user.uid, name: user.displayName, photo: user.photoURL }) });
                const unsub = onSnapshot(ref, d => {
                    if(d.exists()) { setParty(d.data()); setMsgs(d.data().messages || []); }
                    else { alert("Sala terminada"); onLeave(); }
                });
                return () => { updateDoc(ref, { users: arrayRemove({ uid: user.uid, name: user.displayName, photo: user.photoURL }) }); unsub(); };
            }, [partyId]);

            useEffect(() => chatRef.current?.scrollIntoView({ behavior: 'smooth' }), [msgs]);

            const updateState = async (play, t) => {
                await updateDoc(doc(db, 'artifacts', APP_ID, 'parties', `party_${partyId}`), { 
                    isPlaying: play, timestamp: t, lastUpdated: Date.now(),
                    messages: arrayUnion({ id: Date.now(), system: true, text: play ? '‚ñ∂Ô∏è Reanudado' : '‚è∏Ô∏è Pausado' })
                });
            };

            const loadYt = async () => {
                const id = getYouTubeId(search);
                if(!id) return alert("Link inv√°lido de YouTube");
                await updateDoc(doc(db, 'artifacts', APP_ID, 'parties', `party_${partyId}`), {
                    currentVideoId: id, isPlaying: true, timestamp: 0, lastUpdated: Date.now(),
                    messages: arrayUnion({ id: Date.now(), system: true, text: 'üì∫ Video cambiado' })
                });
                setSearch('');
            };

            const send = async (e) => {
                e.preventDefault(); if(!txt.trim()) return;
                await updateDoc(doc(db, 'artifacts', APP_ID, 'parties', `party_${partyId}`), {
                    messages: arrayUnion({ id: Date.now(), text: txt, sender: user.displayName, photo: user.photoURL, timestamp: Date.now() })
                });
                setTxt('');
            };

            const copyCode = () => {
                navigator.clipboard.writeText(partyId);
                alert("C√≥digo copiado: " + partyId);
            };

            if(!party) return <div className="h-screen bg-slate-950 flex items-center justify-center text-white"><Loader2 className="animate-spin mr-2"/> Entrando...</div>;

            return (
                <div className="app-layout bg-black">
                    <div ref={containerRef} className="hidden"></div>

                    {/* ZONA PRINCIPAL */}
                    <div className="flex-1 flex flex-col relative bg-zinc-950">
                        {/* Header Overlay */}
                        <div className="absolute top-0 left-0 w-full p-4 z-20 flex justify-between pointer-events-none">
                            <div className="flex gap-2 pointer-events-auto">
                                <div onClick={copyCode} className="glass px-3 py-1.5 rounded-full flex items-center gap-2 cursor-pointer hover:bg-white/10 text-xs font-bold tracking-widest text-zinc-300">
                                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> {partyId} <Copy size={12}/>
                                </div>
                                <button onClick={toggle} className={`glass p-1.5 rounded-full ${!muted ? 'bg-green-500/20 text-green-400 border-green-500/50' : 'text-red-400'}`}>
                                    {!muted ? <Mic size={14}/> : <MicOff size={14}/>}
                                </button>
                            </div>
                            <button onClick={onLeave} className="glass p-2 rounded-full hover:bg-red-600/50 pointer-events-auto"><LogOut size={16}/></button>
                        </div>

                        {/* Player */}
                        <div className="flex-1 relative flex items-center justify-center">
                            {party.service === 'youtube' ? (
                                party.currentVideoId ? (
                                    <YTPlayer videoId={party.currentVideoId} state={party} isHost={isHost} onUpdate={updateState}/>
                                ) : (
                                    <div className="text-center opacity-30">
                                        <Search size={48} className="mx-auto mb-2"/>
                                        <p>Busca un video</p>
                                    </div>
                                )
                            ) : (
                                <CrunchyController state={party} isHost={isHost} onUpdate={updateState}/>
                            )}
                        </div>

                        {/* Controles (Solo YouTube & Host) */}
                        {party.service === 'youtube' && isHost && (
                            <div className="p-4 bg-zinc-900 border-t border-white/5 flex gap-2">
                                <div className="flex-1 bg-black border border-zinc-700 rounded-full px-4 py-2 flex items-center gap-2">
                                    <Search size={16} className="text-zinc-500"/>
                                    <input className="bg-transparent border-none outline-none w-full text-sm" placeholder="Link de YouTube..." value={search} onChange={e=>setSearch(e.target.value)} onKeyDown={e=>e.key==='Enter'&&loadYt()}/>
                                </div>
                                <button onClick={loadYt} className="bg-white text-black font-bold px-4 rounded-full text-xs hover:scale-105 transition">VER</button>
                            </div>
                        )}
                    </div>

                    {/* BARRA LATERAL (CHAT) */}
                    <div className="h-[40vh] lg:h-full lg:w-96 bg-slate-950 border-t lg:border-t-0 lg:border-l border-white/10 flex flex-col">
                        {/* Lista Usuarios */}
                        <div className="h-14 border-b border-white/5 flex items-center px-4 gap-2 overflow-x-auto hide-scroll">
                            {party.users?.map((u, i) => (
                                <img key={i} src={u.photo} className="w-8 h-8 rounded-full border border-white/10" title={u.name}/>
                            ))}
                        </div>

                        {/* Mensajes */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {msgs.map((m, i) => (
                                <div key={i} className={`flex flex-col ${m.system ? 'items-center opacity-50 text-[10px] uppercase tracking-widest my-2' : ''}`}>
                                    {m.system ? m.text : (
                                        <div className="flex gap-3 fade-in">
                                            <img src={m.photo} className="w-8 h-8 rounded-full bg-zinc-800"/>
                                            <div>
                                                <div className="flex items-baseline gap-2">
                                                    <span className="text-xs font-bold text-zinc-400">{m.sender}</span>
                                                    <span className="text-[9px] text-zinc-600">{new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                                                </div>
                                                <p className="text-sm text-zinc-200">{m.text}</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                            <div ref={chatRef}></div>
                        </div>

                        {/* Input */}
                        <form onSubmit={send} className="p-3 border-t border-white/5 flex gap-2 bg-slate-900">
                            <input className="flex-1 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition" placeholder="Chat..." value={txt} onChange={e=>setTxt(e.target.value)}/>
                            <button type="submit" className="p-2 bg-blue-600 rounded-lg"><Send size={16}/></button>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activePartyId, setActivePartyId] = useState(null);

            useEffect(() => onAuthStateChanged(auth, u => {
                setUser(u);
                const p = new URLSearchParams(window.location.search).get('room');
                if(u && p) setActivePartyId(p);
            }), []);

            const create = async (service) => {
                const id = generateId();
                await setDoc(doc(db, 'artifacts', APP_ID, 'parties', `party_${id}`), {
                    hostId: user.uid, service, currentVideoId: '', isPlaying: false, timestamp: 0, lastUpdated: Date.now(), users: [], messages: []
                });
                setActivePartyId(id);
                window.history.pushState({}, '', `?room=${id}`);
            };

            const join = async (id) => {
                if(!id) return;
                setActivePartyId(id);
            };

            if (!user) return (
                <div className="min-h-screen bg-black flex items-center justify-center p-6 text-center">
                    <div className="glass p-10 rounded-3xl max-w-sm w-full border-t border-white/10">
                        <h1 className="text-5xl font-black mb-2 tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">StreamParty</h1>
                        <p className="text-slate-400 mb-8 font-medium">Versi√≥n Final v9</p>
                        <button onClick={() => signInWithPopup(auth, new GoogleAuthProvider())} className="w-full bg-white text-black font-bold py-3 rounded-xl hover:scale-[1.02] transition">Entrar con Google</button>
                    </div>
                </div>
            );

            if (activePartyId) return <PartyRoom partyId={activePartyId} user={user} onLeave={() => {setActivePartyId(null); window.history.pushState({}, '', window.location.pathname);}} />;

            return <Dashboard user={user} create={create} join={join} />;
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>



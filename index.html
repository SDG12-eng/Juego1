<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamParty - Multicines</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #fff; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .service-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px -10px rgba(124, 58, 237, 0.5); }
        .mic-active { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- API de YouTube -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, onSnapshot, updateDoc, arrayUnion, setDoc, collection, addDoc, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { 
            Play, Pause, MessageSquare, Users, LogOut, Plus, Send, Copy, 
            Mic, Search, Loader2, MonitorPlay, Tv
        } from 'https://esm.sh/lucide-react@0.344.0';

        // --- CONFIGURACI√ìN FIREBASE (Tu configuraci√≥n) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJNTDKf8RrUQ_bvt9z1FD3hBQ9TtgFcuE",
            authDomain: "streaming-72bc2.firebaseapp.com",
            projectId: "streaming-72bc2",
            storageBucket: "streaming-72bc2.firebasestorage.app",
            messagingSenderId: "118775184891",
            appId: "1:118775184891:web:e3234a80dad9beec725f5e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'stream-party-v4-final'; 

        // --- DATOS DE SERVICIOS ---
        const SERVICES = [
            { id: 'youtube', name: 'YouTube', color: 'bg-red-600', icon: 'YT', type: 'embed' },
            { id: 'netflix', name: 'Netflix', color: 'bg-red-700', icon: 'N', type: 'external' },
            { id: 'disney', name: 'Disney+', color: 'bg-blue-900', icon: 'D+', type: 'external' },
            { id: 'prime', name: 'Prime Video', color: 'bg-blue-500', icon: 'P', type: 'external' },
            { id: 'hbo', name: 'Max', color: 'bg-purple-700', icon: 'HBO', type: 'external' },
            { id: 'crunchyroll', name: 'Crunchyroll', color: 'bg-orange-500', icon: 'CR', type: 'external' },
            { id: 'twitch', name: 'Twitch', color: 'bg-purple-600', icon: 'Tw', type: 'embed' },
        ];

        // --- UTILIDADES ---
        const generatePartyId = () => Math.random().toString(36).substring(2, 7).toUpperCase();
        const getYouTubeId = (url) => {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        // --- COMPONENTE: YOUTUBE PLAYER ---
        const YouTubePlayer = ({ videoId, isPlaying, timestamp, onStateChange }) => {
            const playerRef = useRef(null);

            useEffect(() => {
                if (!window.YT) return;
                if (playerRef.current) try { playerRef.current.destroy(); } catch(e){}

                playerRef.current = new window.YT.Player('yt-player', {
                    height: '100%', width: '100%', videoId: videoId,
                    playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1, 'origin': window.location.origin },
                    events: {
                        'onReady': (e) => { if (isPlaying) e.target.playVideo(); },
                        'onStateChange': (e) => { if (e.data === 1 || e.data === 2) onStateChange(e.data === 1, e.target.getCurrentTime()); }
                    }
                });
                return () => { if (playerRef.current) try { playerRef.current.destroy(); } catch(e){} }
            }, [videoId]);

            useEffect(() => {
                if (!playerRef.current?.getPlayerState) return;
                try {
                    const state = playerRef.current.getPlayerState();
                    const current = playerRef.current.getCurrentTime();
                    if (isPlaying && state !== 1 && state !== 3) playerRef.current.playVideo();
                    if (!isPlaying && state === 1) playerRef.current.pauseVideo();
                    if (Math.abs(current - timestamp) > 2) playerRef.current.seekTo(timestamp, true);
                } catch (e) {}
            }, [isPlaying, timestamp]);

            return <div id="yt-player" className="w-full h-full bg-black"></div>;
        };

        // --- COMPONENTE: VOICE CHAT ---
        const VoiceChat = ({ partyId, user }) => {
            const [isRecording, setIsRecording] = useState(false);
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);

            useEffect(() => {
                const q = query(collection(db, 'artifacts', appId, 'parties', `party_${partyId}`, 'audio'), orderBy('timestamp', 'desc'), limit(1));
                const unsubscribe = onSnapshot(q, (s) => {
                    s.docChanges().forEach((c) => {
                        if (c.type === "added") {
                            const d = c.doc.data();
                            if (d.senderId !== user.uid && Date.now() - d.timestamp < 10000) new Audio(d.base64).play().catch(e => console.log(e));
                        }
                    });
                });
                return () => unsubscribe();
            }, [partyId]);

            const start = async () => {
                try {
                    const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(s);
                    audioChunksRef.current = [];
                    mediaRecorderRef.current.ondataavailable = (e) => audioChunksRef.current.push(e.data);
                    mediaRecorderRef.current.onstop = async () => {
                        const b = new Blob(audioChunksRef.current, { type: 'audio/webm' });
                        const r = new FileReader();
                        r.readAsDataURL(b);
                        r.onloadend = async () => await addDoc(collection(db, 'artifacts', appId, 'parties', `party_${partyId}`, 'audio'), { senderId: user.uid, base64: r.result, timestamp: Date.now() });
                        s.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                } catch (err) { alert("Microfono requerido"); }
            };

            const stop = () => { if (mediaRecorderRef.current && isRecording) { mediaRecorderRef.current.stop(); setIsRecording(false); } };

            return (
                <button 
                    onMouseDown={start} onMouseUp={stop} onMouseLeave={stop} onTouchStart={start} onTouchEnd={stop}
                    className={`p-4 rounded-full shadow-lg transition-transform ${isRecording ? 'mic-active text-white scale-110' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}
                >
                    <Mic size={24} />
                </button>
            );
        };

        // --- PANTALLA: DASHBOARD (SELECCI√ìN DE SERVICIO) ---
        const Dashboard = ({ user, onCreateParty, onJoinParty, loading }) => {
            return (
                <div className="min-h-screen bg-slate-950 p-6 flex items-center justify-center">
                    <div className="max-w-5xl w-full">
                        <header className="flex justify-between items-center mb-10">
                            <div className="flex items-center gap-4">
                                <img src={user.photoURL} className="w-12 h-12 rounded-full border-2 border-purple-500"/>
                                <div>
                                    <h1 className="text-2xl font-bold text-white">Hola, {user.displayName}</h1>
                                    <p className="text-slate-400">¬øQu√© vamos a ver hoy?</p>
                                </div>
                            </div>
                            <button onClick={() => signOut(auth)} className="text-red-400 hover:text-red-300 font-bold">Salir</button>
                        </header>

                        <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-12">
                            {SERVICES.map(s => (
                                <button 
                                    key={s.id} 
                                    onClick={() => onCreateParty(s.id)}
                                    disabled={loading}
                                    className={`service-card relative aspect-video rounded-2xl overflow-hidden group transition-all duration-300 ${s.color}`}
                                >
                                    <div className="absolute inset-0 bg-black/20 group-hover:bg-transparent transition"></div>
                                    <div className="relative z-10 flex flex-col items-center justify-center h-full text-white">
                                        <span className="text-4xl font-black mb-2">{s.icon}</span>
                                        <span className="font-bold">{s.name}</span>
                                    </div>
                                </button>
                            ))}
                        </div>

                        <div className="glass p-8 rounded-3xl flex flex-col md:flex-row items-center gap-6">
                            <div className="flex-1">
                                <h3 className="text-xl font-bold mb-2">Unirse a una fiesta</h3>
                                <p className="text-slate-400">Pega el c√≥digo que te enviaron tus amigos.</p>
                            </div>
                            <div className="flex gap-3 w-full md:w-auto">
                                <input id="partyCode" placeholder="C√ìDIGO (EJ: X9Y2Z)" className="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-center tracking-widest outline-none focus:border-purple-500 uppercase text-white" />
                                <button onClick={() => onJoinParty(document.getElementById('partyCode').value.toUpperCase())} className="bg-white text-black font-bold px-8 rounded-xl hover:scale-105 transition">Entrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- PANTALLA: SALA DE FIESTA ---
        const PartyRoom = ({ partyId, user, onLeave }) => {
            const [partyData, setPartyData] = useState(null);
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState('');
            const [search, setSearch] = useState('');
            const chatRef = useRef(null);

            useEffect(() => {
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'parties', `party_${partyId}`), (d) => {
                    if (d.exists()) {
                        setPartyData(d.data());
                        if (d.data().messages) setMessages(d.data().messages);
                    } else {
                        alert("Sala cerrada"); onLeave();
                    }
                });
                return () => unsub();
            }, [partyId]);

            useEffect(() => chatRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages]);

            const updateState = async (p, t) => await updateDoc(doc(db, 'artifacts', appId, 'parties', `party_${partyId}`), { isPlaying: p, timestamp: t });
            
            const loadVideo = async () => {
                const vid = getYouTubeId(search);
                if (!vid) return window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(search)}`, '_blank');
                await updateDoc(doc(db, 'artifacts', appId, 'parties', `party_${partyId}`), { currentVideoId: vid, isPlaying: true, messages: arrayUnion({ id: Date.now(), text: 'üé• Nuevo video', sender: 'Sistema', system: true }) });
                setSearch('');
            };

            const send = async (e) => {
                e.preventDefault();
                if (!text.trim()) return;
                await updateDoc(doc(db, 'artifacts', appId, 'parties', `party_${partyId}`), { messages: arrayUnion({ id: Date.now(), text, sender: user.displayName, photo: user.photoURL, timestamp: Date.now() }) });
                setText('');
            };

            // PREVENCI√ìN DE ERROR: Si no hay datos, mostramos cargando
            if (!partyData) return <div className="h-screen bg-black flex items-center justify-center text-white"><Loader2 className="animate-spin mr-2"/> Cargando sala...</div>;

            const service = SERVICES.find(s => s.id === partyData.serviceId) || SERVICES[0];

            return (
                <div className="flex flex-col md:flex-row h-screen bg-black overflow-hidden">
                    {/* ZONA IZQUIERDA: VIDEO / CONTENIDO */}
                    <div className="flex-1 flex flex-col relative">
                        <div className="absolute top-0 left-0 w-full z-20 p-4 flex justify-between items-center bg-gradient-to-b from-black/90 to-transparent pointer-events-none hover:pointer-events-auto transition-opacity opacity-0 hover:opacity-100">
                             <div className="glass px-4 py-2 rounded-full flex items-center gap-2 pointer-events-auto cursor-pointer" onClick={() => navigator.clipboard.writeText(partyId)}>
                                <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                <span className="text-sm font-mono">ID: {partyId}</span>
                                <Copy size={14}/>
                            </div>
                            <button onClick={onLeave} className="bg-red-600/80 p-2 rounded-full pointer-events-auto hover:bg-red-600"><LogOut size={18}/></button>
                        </div>

                        <div className="flex-1 bg-slate-900 flex items-center justify-center relative">
                            {service.id === 'youtube' ? (
                                partyData.currentVideoId ? (
                                    <YouTubePlayer videoId={partyData.currentVideoId} isPlaying={partyData.isPlaying} timestamp={partyData.timestamp} onStateChange={updateState} />
                                ) : (
                                    <div className="text-center text-slate-500">
                                        <Play size={64} className="mx-auto mb-4 opacity-50"/>
                                        <p>Busca un video de YouTube abajo</p>
                                    </div>
                                )
                            ) : (
                                // Pantalla para servicios externos (Netflix, Disney, etc.)
                                <div className="text-center p-8 max-w-lg">
                                    <div className={`w-24 h-24 ${service.color} rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-2xl`}>
                                        <span className="text-4xl font-black text-white">{service.icon}</span>
                                    </div>
                                    <h2 className="text-2xl font-bold text-white mb-2">Sala de {service.name}</h2>
                                    <p className="text-slate-400 mb-6">
                                        Debido a protecciones de copyright, {service.name} debe abrirse en otra pesta√±a.
                                        Usen este chat para comentar mientras ven la pel√≠cula.
                                    </p>
                                    <a href={`https://www.${service.id}.com`} target="_blank" className="bg-white text-black px-6 py-3 rounded-full font-bold hover:scale-105 transition inline-block">
                                        Abrir {service.name}
                                    </a>
                                </div>
                            )}
                        </div>

                        {/* BARRA DE CONTROL (Solo visible en YouTube) */}
                        {service.id === 'youtube' && (
                            <div className="bg-black p-4 border-t border-slate-800 flex gap-4 items-center">
                                <div className="flex-1 flex items-center bg-slate-900 border border-slate-700 rounded-full px-4 py-2">
                                    <Search size={18} className="text-slate-400 mr-2"/>
                                    <input className="bg-transparent border-none outline-none w-full text-white text-sm" placeholder="Link de YouTube..." value={search} onChange={e => setSearch(e.target.value)} onKeyDown={e => e.key === 'Enter' && loadVideo()}/>
                                    <button onClick={loadVideo} className="bg-purple-600 text-white text-xs font-bold px-3 py-1 rounded-full ml-2">VER</button>
                                </div>
                                <VoiceChat partyId={partyId} user={user} />
                            </div>
                        )}
                        {/* Control de voz para otros servicios */}
                        {service.id !== 'youtube' && (
                             <div className="bg-black p-4 border-t border-slate-800 flex justify-center items-center">
                                <div className="text-slate-500 text-sm mr-4">Mant√©n presionado para hablar -></div>
                                <VoiceChat partyId={partyId} user={user} />
                             </div>
                        )}
                    </div>

                    {/* ZONA DERECHA: CHAT */}
                    <div className="w-full md:w-80 bg-slate-950 border-l border-slate-800 flex flex-col h-[40vh] md:h-full">
                        <div className="p-4 border-b border-slate-800 font-bold text-slate-400 text-xs tracking-widest uppercase">Chat de Sala</div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {messages.map((m, i) => (
                                <div key={i} className={`flex gap-3 ${m.system ? 'justify-center' : ''}`}>
                                    {m.system ? <span className="text-[10px] bg-slate-900 text-slate-500 px-3 py-1 rounded-full">{m.text}</span> : (
                                        <>
                                            <img src={m.photo} className="w-8 h-8 rounded-full bg-slate-800"/>
                                            <div>
                                                <div className="text-xs font-bold text-slate-400">{m.sender}</div>
                                                <div className="text-sm text-slate-200">{m.text}</div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            ))}
                            <div ref={chatRef}></div>
                        </div>
                        <form onSubmit={send} className="p-3 bg-slate-900 border-t border-slate-800 flex gap-2">
                            <input className="flex-1 bg-black border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-purple-500" value={text} onChange={e => setText(e.target.value)} placeholder="Escribe aqu√≠..."/>
                            <button type="submit" className="p-2 bg-purple-600 rounded-lg text-white hover:bg-purple-500"><Send size={18}/></button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [activePartyId, setActivePartyId] = useState(null);
            const [loading, setLoading] = useState(false);

            useEffect(() => onAuthStateChanged(auth, setUser), []);

            const create = async (serviceId) => {
                setLoading(true);
                const id = generatePartyId();
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'parties', `party_${id}`), {
                        host: user.uid, serviceId, currentVideoId: '', isPlaying: false, timestamp: 0, messages: []
                    });
                    setActivePartyId(id);
                } catch(e) { console.error(e); }
                setLoading(false);
            };

            const join = async (id) => {
                setLoading(true);
                const d = await getDoc(doc(db, 'artifacts', appId, 'parties', `party_${id}`));
                if (d.exists()) setActivePartyId(id);
                else alert("Sala no existe");
                setLoading(false);
            };

            if (!user) return (
                <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-6 text-center">
                    <div className="w-24 h-24 bg-gradient-to-tr from-purple-600 to-blue-600 rounded-3xl flex items-center justify-center mb-6 shadow-2xl shadow-purple-900/30">
                        <MonitorPlay size={48} className="text-white"/>
                    </div>
                    <h1 className="text-5xl md:text-7xl font-black text-white mb-6 tracking-tighter">StreamParty</h1>
                    <p className="text-slate-400 text-xl mb-10 max-w-lg">Cine virtual sincronizado con amigos. YouTube, chat de voz y m√°s.</p>
                    <button onClick={() => signInWithPopup(auth, new GoogleAuthProvider())} className="bg-white text-slate-900 px-8 py-4 rounded-full font-bold text-lg hover:scale-105 transition flex items-center gap-3">
                        <img src="https://www.svgrepo.com/show/475656/google-color.svg" className="w-6 h-6"/> Iniciar con Google
                    </button>
                </div>
            );

            if (activePartyId) return <PartyRoom partyId={activePartyId} user={user} onLeave={() => setActivePartyId(null)} />;

            return <Dashboard user={user} onCreateParty={create} onJoinParty={join} loading={loading} />;
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>



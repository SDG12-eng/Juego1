<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamParty Mobile</title>
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Librer铆as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; overflow: hidden; height: 100vh; width: 100vw; }
        .glass { background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .mic-wave { animation: wave 1s infinite ease-in-out; }
        @keyframes wave { 0%, 100% { height: 10%; } 50% { height: 100%; } }
        /* Ajuste para m贸viles: Chat ocupa el espacio restante */
        .mobile-layout { display: flex; flex-direction: column; height: 100%; }
        @media (min-width: 768px) { .mobile-layout { flex-direction: row; } }
        iframe { border: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, setDoc, arrayRemove, collection, query, orderBy, limit, addDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { 
            Play, Pause, Users, LogOut, Send, Mic, MicOff, Search, Loader2, 
            Crown, Link as LinkIcon, Volume2, Globe, ExternalLink, Zap, MonitorPlay, AlertTriangle, X
        } from 'https://esm.sh/lucide-react@0.344.0';

        // --- CONFIGURACIN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJNTDKf8RrUQ_bvt9z1FD3hBQ9TtgFcuE",
            authDomain: "streaming-72bc2.firebaseapp.com",
            projectId: "streaming-72bc2",
            storageBucket: "streaming-72bc2.firebasestorage.app",
            messagingSenderId: "118775184891",
            appId: "1:118775184891:web:e3234a80dad9beec725f5e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'stream-party-v8-responsive'; 

        // --- UTILIDADES ---
        const generateId = () => Math.random().toString(36).substring(2, 6).toUpperCase();
        const getYouTubeId = (url) => {
            if (!url) return null;
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        // --- GESTOR DE AUDIO P2P ---
        const useVoiceChat = (user, partyId, activeUsers) => {
            const [peer, setPeer] = useState(null);
            const [myStream, setMyStream] = useState(null);
            const [isMuted, setIsMuted] = useState(false);
            const audioGridRef = useRef(null);

            useEffect(() => {
                if (!user || !partyId) return;
                const newPeer = new window.Peer(user.uid.substring(0, 10) + partyId);
                newPeer.on('open', () => {
                    setPeer(newPeer);
                    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => setMyStream(stream)).catch(console.error);
                });
                newPeer.on('call', call => {
                    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                        call.answer(stream);
                        call.on('stream', remote => addAudio(call.peer, remote));
                    });
                });
                return () => { newPeer.destroy(); if(myStream) myStream.getTracks().forEach(t=>t.stop()); };
            }, [user, partyId]);

            useEffect(() => {
                if (!peer || !myStream || !activeUsers) return;
                activeUsers.forEach(u => {
                    const pid = u.uid.substring(0, 10) + partyId;
                    if (u.uid !== user.uid) {
                        const call = peer.call(pid, myStream);
                        if(call) call.on('stream', remote => addAudio(pid, remote));
                    }
                });
            }, [activeUsers, peer, myStream]);

            const addAudio = (id, stream) => {
                if (document.getElementById(`audio-${id}`)) return;
                const a = document.createElement('audio');
                a.id = `audio-${id}`; a.srcObject = stream; a.autoplay = true;
                if(audioGridRef.current) audioGridRef.current.appendChild(a);
            };

            const toggleMute = () => {
                if (myStream) {
                    const track = myStream.getAudioTracks()[0];
                    track.enabled = !track.enabled;
                    setIsMuted(!track.enabled);
                }
            };
            return { isMuted, toggleMute, audioGridRef };
        };

        // --- COMPONENTE: YOUTUBE PLAYER ---
        const YouTubePlayer = ({ videoId, partyState, isHost, onUpdate }) => {
            const playerRef = useRef(null);
            useEffect(() => {
                if (!window.YT) return;
                playerRef.current = new window.YT.Player('yt-player', {
                    height: '100%', width: '100%', videoId: videoId,
                    playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1, 'origin': window.location.origin },
                    events: {
                        'onReady': e => { if(partyState.isPlaying) e.target.playVideo(); },
                        'onStateChange': e => { if(isHost && (e.data===1 || e.data===2)) onUpdate(e.data===1, e.target.getCurrentTime()); }
                    }
                });
                const i = setInterval(() => {
                    if(!playerRef.current?.getPlayerState || isHost) return;
                    const t = partyState.isPlaying ? partyState.timestamp + (Date.now()-partyState.lastUpdated)/1000 : partyState.timestamp;
                    if(Math.abs(playerRef.current.getCurrentTime() - t) > 2) playerRef.current.seekTo(t, true);
                    const s = playerRef.current.getPlayerState();
                    if(partyState.isPlaying && s!==1 && s!==3) playerRef.current.playVideo();
                    if(!partyState.isPlaying && s===1) playerRef.current.pauseVideo();
                }, 1000);
                return () => { clearInterval(i); try{playerRef.current.destroy()}catch(e){} };
            }, [videoId]);
            return <div id="yt-player" className="w-full h-full"></div>;
        };

        // --- COMPONENTE: NAVEGADOR INTEGRADO (EXPERIMENTAL) ---
        const WebBrowserPlayer = ({ url, isHost }) => {
            const [blocked, setBlocked] = useState(false);

            // Intentamos cargar. Si falla (por CSP), el usuario ver谩 blanco o error.
            return (
                <div className="w-full h-full relative bg-white">
                    {!blocked ? (
                        <iframe 
                            src={url} 
                            className="w-full h-full"
                            allow="autoplay; encrypted-media; fullscreen"
                            onError={() => setBlocked(true)}
                        />
                    ) : (
                        <div className="absolute inset-0 bg-slate-900 flex flex-col items-center justify-center p-6 text-center">
                            <AlertTriangle size={48} className="text-yellow-500 mb-4"/>
                            <h3 className="text-xl font-bold mb-2">Sitio Protegido</h3>
                            <p className="text-slate-400 mb-6">Este sitio web bloquea la reproducci贸n dentro de otras apps.</p>
                            <a href={url} target="_blank" className="bg-blue-600 px-6 py-3 rounded-full font-bold">Abrir en Pesta帽a Nueva</a>
                        </div>
                    )}
                    
                    {/* Bot贸n de p谩nico si sale blanco */}
                    <div className="absolute top-2 right-2 z-50">
                        <button onClick={() => setBlocked(true)} className="bg-black/50 p-2 rounded-full text-white text-xs backdrop-blur-md border border-white/20">
                            驴No carga?
                        </button>
                    </div>
                </div>
            );
        };

        // --- SALA PRINCIPAL ---
        const PartyRoom = ({ partyId, user, onLeave }) => {
            const [party, setParty] = useState(null);
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [search, setSearch] = useState('');
            const [showUsers, setShowUsers] = useState(false);
            const chatRef = useRef(null);
            const { isMuted, toggleMute, audioGridRef } = useVoiceChat(user, partyId, party?.users);
            
            const isHost = party?.hostId === user.uid;

            useEffect(() => {
                const ref = doc(db, 'artifacts', APP_ID, 'parties', `party_${partyId}`);
                updateDoc(ref, { users: arrayUnion({ uid: user.uid, name: user.displayName, photo: user.photoURL }) });
                const unsub = onSnapshot(ref, d => {
                    if(d.exists()) { setParty(d.data()); setMessages(d.data().messages || []); }
                    else { alert("Sala cerrada"); onLeave(); }
                });
                return () => { updateDoc(ref, { users: arrayRemove({ uid: user.uid, name: user.displayName, photo: user.photoURL }) }); unsub(); };
            }, [partyId]);

            useEffect(() => chatRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages]);

            const handleUpdate = async (playing, time) => {
                await updateDoc(doc(db, 'artifacts', APP_ID, 'parties', `party_${partyId}`), {
                    isPlaying: playing, timestamp: time, lastUpdated: Date.now()
                });
            };

            const loadContent = async () => {
                if(!isHost) return;
                const ytId = getYouTubeId(search);
                // Si es youtube ID, guardamos ID. Si no, guardamos URL completa para el iframe.
                await updateDoc(doc(db, 'artifacts', APP_ID, 'parties', `party_${partyId}`), {
                    currentVideoId: ytId || search, // search act煤a como URL directa
                    service: ytId ? 'youtube' : 'web',
                    isPlaying: true, timestamp: 0, lastUpdated: Date.now(),
                    messages: arrayUnion({ id: Date.now(), system: true, text: ' Contenido cambiado' })
                });
                setSearch('');
            };

            const send = async (e) => {
                e.preventDefault(); if(!input.trim()) return;
                await updateDoc(doc(db, 'artifacts', APP_ID, 'parties', `party_${partyId}`), {
                    messages: arrayUnion({ id: Date.now(), text: input, sender: user.displayName, photo: user.photoURL, timestamp: Date.now() })
                });
                setInput('');
            };

            if(!party) return <div className="h-screen bg-black flex items-center justify-center text-white"><Loader2 className="animate-spin"/></div>;

            return (
                <div className="mobile-layout bg-black h-screen w-full overflow-hidden">
                    <div ref={audioGridRef} className="hidden"></div>

                    {/* 1. SECCIN VIDEO (Arriba en m贸vil, Izquierda en PC) */}
                    <div className="w-full md:flex-1 h-[35vh] md:h-full relative flex flex-col bg-black z-10 shadow-xl">
                        {/* Header Flotante */}
                        <div className="absolute top-0 left-0 w-full p-2 md:p-4 flex justify-between items-start z-20 pointer-events-none bg-gradient-to-b from-black/80 to-transparent">
                            <div className="flex gap-2 pointer-events-auto">
                                <div className="glass px-3 py-1.5 rounded-full flex items-center gap-2 cursor-pointer" onClick={() => {navigator.clipboard.writeText(window.location.href); alert("Link copiado")}}>
                                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span className="text-xs font-bold tracking-widest hidden md:inline">INVITAR</span>
                                    <LinkIcon size={14}/>
                                </div>
                                <button onClick={toggleMute} className={`glass px-3 py-1.5 rounded-full ${isMuted?'text-red-400':'text-green-400'}`}>
                                    {isMuted ? <MicOff size={14}/> : <Mic size={14}/>}
                                </button>
                            </div>
                            <div className="flex gap-2 pointer-events-auto">
                                <button onClick={()=>setShowUsers(!showUsers)} className="glass p-2 rounded-full md:hidden relative">
                                    <Users size={16}/>
                                    <span className="absolute -top-1 -right-1 bg-red-500 text-[10px] w-4 h-4 rounded-full flex items-center justify-center">{party.users?.length}</span>
                                </button>
                                <button onClick={onLeave} className="glass p-2 rounded-full hover:bg-red-600/50"><LogOut size={16}/></button>
                            </div>
                        </div>

                        {/* Player Container */}
                        <div className="flex-1 relative">
                            {party.currentVideoId ? (
                                party.service === 'youtube' ? (
                                    <YouTubePlayer videoId={party.currentVideoId} partyState={party} isHost={isHost} onUpdate={handleUpdate} />
                                ) : (
                                    <WebBrowserPlayer url={party.currentVideoId} isHost={isHost} />
                                )
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center text-slate-500 bg-slate-900">
                                    <MonitorPlay size={48} className="mb-4 opacity-50"/>
                                    <p className="text-sm">Esperando contenido...</p>
                                </div>
                            )}
                        </div>

                        {/* Barra de Control (Host Only) - Ahora compacta para m贸vil */}
                        {isHost && (
                            <div className="p-2 md:p-4 bg-slate-900 border-t border-white/10 flex gap-2 items-center">
                                <div className="flex-1 bg-black/50 border border-slate-700 rounded-full px-3 py-2 flex items-center gap-2">
                                    <Globe size={14} className="text-slate-400"/>
                                    <input 
                                        className="bg-transparent border-none outline-none w-full text-xs md:text-sm text-white" 
                                        placeholder="Link de YouTube, Crunchyroll, etc..." 
                                        value={search} onChange={e=>setSearch(e.target.value)}
                                    />
                                </div>
                                <button onClick={loadContent} className="bg-purple-600 px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">IR</button>
                            </div>
                        )}
                    </div>

                    {/* 2. SECCIN CHAT (Abajo en m贸vil, Derecha en PC) */}
                    <div className="flex-1 md:w-80 md:flex-none flex flex-col bg-slate-950 border-t md:border-t-0 md:border-l border-slate-800 min-h-0 relative">
                        
                        {/* Lista de Usuarios (Overlay en m贸vil) */}
                        {showUsers && (
                            <div className="absolute inset-0 bg-slate-900/95 z-30 p-4 animate-fade-in md:hidden">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold">Usuarios en Sala</h3>
                                    <button onClick={()=>setShowUsers(false)}><X/></button>
                                </div>
                                {party.users?.map((u,i) => (
                                    <div key={i} className="flex items-center gap-3 p-2 border-b border-white/5">
                                        <img src={u.photo} className="w-8 h-8 rounded-full"/>
                                        <span>{u.name}</span>
                                        {u.uid===party.hostId && <Crown size={14} className="text-yellow-400"/>}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Chat Messages */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
                            {messages.map((m, i) => (
                                <div key={i} className={`flex flex-col ${m.system ? 'items-center opacity-60 my-2' : ''}`}>
                                    {m.system ? <span className="text-[10px] bg-white/10 px-2 py-1 rounded-full">{m.text}</span> : (
                                        <div className="flex gap-2">
                                            <img src={m.photo} className="w-6 h-6 md:w-8 md:h-8 rounded-full bg-slate-800 flex-shrink-0"/>
                                            <div className="min-w-0">
                                                <div className="flex items-baseline gap-2">
                                                    <span className="text-xs font-bold text-slate-300">{m.sender}</span>
                                                    <span className="text-[9px] text-slate-600">{new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                                </div>
                                                <p className="text-sm text-slate-200 break-words leading-tight">{m.text}</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                            <div ref={chatRef}></div>
                        </div>

                        {/* Input Area */}
                        <form onSubmit={send} className="p-2 md:p-3 bg-slate-900 border-t border-white/10 flex gap-2 items-center safe-area-pb">
                            <input 
                                className="flex-1 bg-black border border-slate-700 rounded-full px-4 py-2.5 text-sm focus:border-purple-500 outline-none transition" 
                                placeholder="Di algo..." 
                                value={input} onChange={e=>setInput(e.target.value)}
                            />
                            <button type="submit" className="p-2.5 bg-purple-600 rounded-full text-white shadow-lg hover:bg-purple-500 active:scale-95 transition">
                                <Send size={18}/>
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activePartyId, setActivePartyId] = useState(null);

            useEffect(() => {
                onAuthStateChanged(auth, u => {
                    setUser(u);
                    const p = new URLSearchParams(window.location.search).get('room');
                    if(u && p) setActivePartyId(p);
                });
            }, []);

            const create = async () => {
                const id = generateId();
                await setDoc(doc(db, 'artifacts', APP_ID, 'parties', `party_${id}`), {
                    hostId: user.uid, currentVideoId: '', service: 'youtube', isPlaying: false, timestamp: 0, lastUpdated: Date.now(), users: [], messages: []
                });
                setActivePartyId(id);
                window.history.pushState({}, '', `?room=${id}`);
            };

            if (!user) return (
                <div className="h-screen bg-slate-950 flex flex-col items-center justify-center p-6 text-center">
                    <div className="w-20 h-20 bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl flex items-center justify-center mb-6 shadow-2xl animate-bounce">
                        <Zap size={40} className="text-white"/>
                    </div>
                    <h1 className="text-4xl font-black mb-2 tracking-tighter text-white">StreamParty</h1>
                    <p className="text-slate-400 mb-8 font-medium text-sm">Tu cine de bolsillo con amigos</p>
                    <button onClick={() => signInWithPopup(auth, new GoogleAuthProvider())} className="bg-white text-black font-bold py-3 px-8 rounded-full shadow-lg active:scale-95 transition flex items-center gap-2">
                        <img src="https://www.svgrepo.com/show/475656/google-color.svg" className="w-5 h-5"/> Entrar con Google
                    </button>
                </div>
            );

            if (activePartyId) return <PartyRoom partyId={activePartyId} user={user} onLeave={() => {setActivePartyId(null); window.history.pushState({}, '', window.location.pathname);}} />;

            return (
                <div className="h-screen bg-slate-950 flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-sm bg-slate-900 p-6 rounded-3xl border border-white/5 shadow-2xl text-center">
                        <img src={user.photoURL} className="w-16 h-16 rounded-full mx-auto border-2 border-purple-500 mb-4"/>
                        <h2 className="text-xl font-bold text-white mb-6">Hola, {user.displayName.split(' ')[0]}</h2>
                        
                        <button onClick={create} className="w-full bg-gradient-to-r from-purple-600 to-pink-600 py-3.5 rounded-xl font-bold text-white shadow-lg active:scale-95 transition mb-4 flex justify-center items-center gap-2">
                            <Zap size={18}/> CREAR SALA
                        </button>
                        
                        <div className="flex gap-2 mb-6">
                            <input id="code" placeholder="CDIGO" className="bg-black border border-slate-700 rounded-xl px-4 flex-1 text-center font-mono uppercase focus:border-purple-500 outline-none text-white text-sm"/>
                            <button onClick={() => setActivePartyId(document.getElementById('code').value.toUpperCase())} className="bg-slate-800 text-white px-4 rounded-xl font-bold text-sm">ENTRAR</button>
                        </div>
                        
                        <button onClick={() => signOut(auth)} className="text-xs text-red-400 font-medium">Cerrar Sesi贸n</button>
                    </div>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>


